<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Sender via QR</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 2rem;
        background-color: #f4f4f9;
        color: #333;
      }
      .container {
        width: 100%;
        max-width: 600px;
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      h1 {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
      }
      .status-message {
        margin-bottom: 1.5rem;
        color: #555;
        min-height: 1.2em;
      }
      .input-mode {
        margin-bottom: 1rem;
      }
      .input-container {
        margin-bottom: 1.5rem;
      }
      #text-input {
        width: 95%;
        min-height: 150px;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .hidden {
        display: none;
      }
      button {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 0 0.5rem;
        transition: background-color 0.2s;
      }
      #start-btn {
        background-color: #007bff;
        color: white;
      }
      #stop-btn {
        background-color: #dc3545;
        color: white;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #qrcode {
        margin-top: 2rem;
        padding: 1rem;
        background: white;
        display: inline-block;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>QR Data Sender</h1>
      <p class="status-message" id="status-message">
        전송할 파일이나 텍스트를 선택하세요.
      </p>

      <div class="input-mode">
        <label
          ><input type="radio" name="input-type" value="file" checked />
          파일</label
        >
        <label
          ><input type="radio" name="input-type" value="text" /> 텍스트</label
        >
      </div>

      <div class="input-container">
        <input type="file" id="file-input" />
        <textarea
          id="text-input"
          class="hidden"
          placeholder="여기에 코드나 텍스트를 붙여넣으세요..."
        ></textarea>
      </div>

      <div>
        <button id="start-btn">전송 시작</button>
        <button id="stop-btn" disabled>전송 중지</button>
      </div>

      <div id="qrcode"></div>
    </div>

    <script src="./qrcode.min.js"></script>
    <script src="./pako.min.js"></script>
    <script>
      // DOM 요소 선택
      const statusMessage = document.getElementById("status-message");
      const fileInput = document.getElementById("file-input");
      const textInput = document.getElementById("text-input");
      const startBtn = document.getElementById("start-btn");
      const stopBtn = document.getElementById("stop-btn");
      const qrCodeContainer = document.getElementById("qrcode");
      const inputTypeRadios = document.querySelectorAll(
        'input[name="input-type"]',
      );

      // 상태 변수
      let isTransferring = false;
      let qrCodeObject = null;
      const CHUNK_SIZE = 250; // 한 QR 코드에 담을 데이터 크기 (bytes)

      // QR 데이터 인코딩 함수 (Base64)
      const encodeData = (index, bytes) => {
        // Uint8Array를 바이너리 문자열로 변환 후 Base64 인코딩
        const binaryString = String.fromCharCode.apply(null, bytes);
        const base64Data = btoa(binaryString);
        return `${index},${base64Data}`;
      };

      // UI 컨트롤 상태 업데이트 함수
      const updateControlsState = (transferring) => {
        isTransferring = transferring;
        startBtn.disabled = transferring;
        stopBtn.disabled = !transferring;
        fileInput.disabled = transferring;
        textInput.disabled = transferring;
        inputTypeRadios.forEach((radio) => (radio.disabled = transferring));
      };

      // 전송 중지 함수
      const stopTransfer = () => {
        updateControlsState(false);
        statusMessage.textContent = "전송이 중지되었습니다. 다시 시작하세요.";
        qrCodeObject.clear();
        qrCodeObject.makeCode("전송 대기 중");
      };

      // 전송 시작 함수
      const startTransfer = async () => {
        const selectedMode = document.querySelector(
          'input[name="input-type"]:checked',
        ).value;
        let dataArray;
        let fileName = "text-data.txt"; // 기본 파일명

        if (selectedMode === "file") {
          const file = fileInput.files[0];
          if (!file) {
            alert("파일을 선택해주세요.");
            return;
          }
          fileName = file.name;
          const arrayBuffer = await file.arrayBuffer();
          dataArray = new Uint8Array(arrayBuffer);
        } else {
          // 'text' mode
          const text = textInput.value;
          if (!text) {
            alert("텍스트를 입력해주세요.");
            return;
          }
          // 텍스트를 UTF-8 바이트 배열로 인코딩
          dataArray = new TextEncoder().encode(text);
        }

        updateControlsState(true);
        statusMessage.textContent = "데이터 압축 중...";

        // 1. 데이터 압축 (pako.gzip)
        const compressedData = pako.gzip(dataArray, { level: 9 });
        const totalChunks = Math.ceil(compressedData.length / CHUNK_SIZE);

        // 2. 메타데이터 생성 및 QR 표시
        const fileMetadata = { name: fileName, chunks: totalChunks };
        qrCodeObject.clear();
        qrCodeObject.makeCode(JSON.stringify(fileMetadata));
        statusMessage.textContent = "전송 시작을 위해 스캐너를 준비하세요...";

        // 메타데이터를 스캔할 시간 (3초)
        await new Promise((resolve) => setTimeout(resolve, 3000));

        // 3. 데이터 청크를 순차적으로 QR 코드로 표시
        for (let i = 0; i < totalChunks; i++) {
          if (!isTransferring) break; // 중지 버튼 클릭 시 루프 탈출

          const start = i * CHUNK_SIZE;
          const chunk = compressedData.subarray(start, start + CHUNK_SIZE);
          const encodedData = encodeData(i, chunk);

          qrCodeObject.clear();
          qrCodeObject.makeCode(encodedData);
          statusMessage.textContent = `데이터 전송 중... (${
            i + 1
          }/${totalChunks})`;

          // 각 QR 코드 표시 간격 (50ms) -> 스캔 속도에 맞춰 조절
          await new Promise((resolve) => setTimeout(resolve, 50));
        }

        if (isTransferring) {
          statusMessage.textContent = "전송 완료!";
        }
        updateControlsState(false);
      };

      // 초기화 코드
      document.addEventListener("DOMContentLoaded", () => {
        // QR 코드 객체 생성
        const qrSize = Math.min(window.innerWidth, window.innerHeight) / 2;
        qrCodeObject = new QRCode(qrCodeContainer, {
          text: "전송 대기 중",
          width: qrSize,
          height: qrSize,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.M,
        });

        // 이벤트 리스너 등록
        startBtn.addEventListener("click", startTransfer);
        stopBtn.addEventListener("click", stopTransfer);

        inputTypeRadios.forEach((radio) => {
          radio.addEventListener("change", (event) => {
            if (event.target.value === "file") {
              fileInput.classList.remove("hidden");
              textInput.classList.add("hidden");
            } else {
              fileInput.classList.add("hidden");
              textInput.classList.remove("hidden");
            }
          });
        });
      });
    </script>
  </body>
</html>
